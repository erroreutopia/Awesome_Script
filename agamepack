#!/bin/bash
set -e

# é»˜è®¤å€¼
GAME_SOURCE_DIR="game"
APP_NAME="Game"
ICON_PATH=""
PACKAGE_TYPE=""
WINE_EXEC=""
WINE_CMD="proton-ge"
NWJS_PATH="$HOME/App/nwjs-sdk/nw"
SAVE_BASE_DIR="$HOME/Game/HTMLGame/NWJS/SAVE"
AUTO_BUILD=false
FORCE_BUILD=false
OUTPUT_FILENAME=""

# è§£æžå‘½ä»¤è¡Œå‚æ•°
while [[ $# -gt 0 ]]; do
    case "$1" in
        -r|--game-dir)
            GAME_SOURCE_DIR="$2"
            shift 2
            ;;
        -i|--icon)
            ICON_PATH="$2"
            shift 2
            ;;
        -n|--name)
            APP_NAME="$2"
            shift 2
            ;;
        -t|--type)
            PACKAGE_TYPE="$2"
            shift 2
            ;;
        --wine-exec)
            WINE_EXEC="$2"
            shift 2
            ;;
        --wine-cmd)
            WINE_CMD="$2"
            shift 2
            ;;
        -y|--yes)
            FORCE_BUILD=true
            shift
            ;;
        -b|--build)
            AUTO_BUILD=true
            shift
            ;;
        -f|-o|--output)
            OUTPUT_FILENAME="$2"
            shift 2
            ;;
        *)
            echo "æœªçŸ¥å‚æ•°: $1"
            exit 1
            ;;
    esac
done

# è®¾ç½®è¾“å‡ºæ–‡ä»¶å
if [ -z "${OUTPUT_FILENAME}" ]; then
    # ä»Žæ¸¸æˆç›®å½•åç”Ÿæˆé»˜è®¤æ–‡ä»¶å
    DIR_NAME=$(basename "$(realpath "${GAME_SOURCE_DIR}")")
    OUTPUT_FILENAME="${DIR_NAME//[^a-zA-Z0-9._-]/}"
    [ -z "${OUTPUT_FILENAME}" ] && OUTPUT_FILENAME="${APP_NAME}"
    echo "ðŸ“ ä½¿ç”¨ç›®å½•åä½œä¸ºé»˜è®¤æ–‡ä»¶å: ${OUTPUT_FILENAME}"
fi

# ç¡®ä¿æœ‰.AppImageåŽç¼€
if [[ "${OUTPUT_FILENAME}" != *.AppImage ]]; then
    OUTPUT_FILENAME="${OUTPUT_FILENAME}.AppImage"
fi

APP_VERSION="1.0"
OUTPUT_DIR="build"
APP_DIR="${OUTPUT_DIR}/${APP_NAME}.AppDir"
APPIMAGE_NAME="${OUTPUT_FILENAME}"

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local has_appimagetool=true
    local has_convert=true
    
    if ! command -v appimagetool &>/dev/null; then
        echo "âš ï¸  appimagetoolæœªå®‰è£…ï¼Œå°†è·³è¿‡æž„å»ºæ­¥éª¤"
        has_appimagetool=false
    fi
    
    if ! command -v convert &>/dev/null; then
        echo "âš ï¸  imagemagickæœªå®‰è£…ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
        has_convert=false
    fi
    
    if [ "$AUTO_BUILD" = true ] && [ "$has_appimagetool" = false ]; then
        echo "âŒ éœ€è¦appimagetoolæ¥æž„å»ºAppImage"
        exit 1
    fi
}

check_dependencies

# éªŒè¯å¹¶åˆ›å»ºæ¸¸æˆç›®å½•
if [ ! -d "${GAME_SOURCE_DIR}" ]; then
    echo "ðŸ”„ æ¸¸æˆç›®å½•ä¸å­˜åœ¨ï¼Œå°è¯•å…¶ä»–ä½ç½®..."
    local possible_dirs=("dist" "build" "www" ".")
    for dir in "${possible_dirs[@]}"; do
        if [ -d "${dir}" ] && ([ -f "${dir}/package.json" ] || [ -f "${dir}/index.html" ] || find "${dir}" -name "*.exe" -print -quit 2>/dev/null); then
            GAME_SOURCE_DIR="${dir}"
            echo "âœ… ä½¿ç”¨ç›®å½•: ${GAME_SOURCE_DIR}"
            break
        fi
    done
    if [ ! -d "${GAME_SOURCE_DIR}" ]; then
        echo "âŒ æ— æ³•æ‰¾åˆ°æœ‰æ•ˆæ¸¸æˆç›®å½•"
        exit 1
    fi
fi

# è‡ªåŠ¨æ£€æµ‹åŒ…ç±»åž‹
if [ -z "${PACKAGE_TYPE}" ]; then
    if [ -f "${GAME_SOURCE_DIR}/package.json" ] || [ -f "${GAME_SOURCE_DIR}/index.html" ]; then
        PACKAGE_TYPE="nwjs"
        echo "âœ… è‡ªåŠ¨æ£€æµ‹: NW.js åº”ç”¨"
    elif find "${GAME_SOURCE_DIR}" -name "*.exe" -print -quit 2>/dev/null; then
        PACKAGE_TYPE="wine"
        echo "âœ… è‡ªåŠ¨æ£€æµ‹: Wine/Windows åº”ç”¨"
    else
        PACKAGE_TYPE="nwjs"
        echo "âš ï¸  æ— æ³•ç¡®å®šç±»åž‹ï¼Œä½¿ç”¨é»˜è®¤: NW.js"
    fi
fi

# åˆ›å»ºç›®å½•ç»“æž„
rm -rf "${OUTPUT_DIR}"
mkdir -p "${APP_DIR}"

# åˆ›å»ºgameå­ç›®å½• (è§£å†³éžASCIIå­—ç¬¦é—®é¢˜)
GAME_SUBDIR="${APP_DIR}/game"
mkdir -p "${GAME_SUBDIR}"

# å¤åˆ¶æ¸¸æˆæ–‡ä»¶åˆ°gameå­ç›®å½•
echo "ðŸ“‚ å¤åˆ¶æ¸¸æˆæ–‡ä»¶: ${GAME_SOURCE_DIR} -> ${GAME_SUBDIR}"
if ! cp -r "${GAME_SOURCE_DIR}/"* "${GAME_SUBDIR}/" 2>/dev/null; then
    echo "âš ï¸  éƒ¨åˆ†æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œå°è¯•å¿½ç•¥é”™è¯¯..."
    cp -r "${GAME_SOURCE_DIR}/"* "${GAME_SUBDIR}/" || true
fi

# åˆ›å»ºç»å¯¹è·¯å¾„ç¬¦å·é“¾æŽ¥ - ç»Ÿä¸€å­˜æ¡£ç›®å½•
ensure_link() {
    local target="$1"
    local link_name="$2"
    [ -e "${link_name}" ] && rm -rf "${link_name}"
    mkdir -p "$(dirname "${target}")"
    ln -sfn "${target}" "${link_name}"
    echo "ðŸ”— ${link_name} -> ${target}"
}

# ç»Ÿä¸€å­˜æ¡£ç›®å½•è·¯å¾„
GAME_SAVE_DIR="${SAVE_BASE_DIR}/${APP_NAME}"

# æ‰€æœ‰saveé“¾æŽ¥éƒ½æŒ‡å‘åŒä¸€ä¸ªç›®å½•
ensure_link "${GAME_SAVE_DIR}" "${APP_DIR}/save"
ensure_link "${GAME_SAVE_DIR}" "${GAME_SUBDIR}/save"
mkdir -p "${GAME_SUBDIR}/www"
ensure_link "${GAME_SAVE_DIR}" "${GAME_SUBDIR}/www/save"

# åˆ›å»ºAppRun
case "${PACKAGE_TYPE}" in
    "nwjs")
        cat > "${APP_DIR}/AppRun" << EOF
#!/bin/bash
APPDIR="\$(dirname "\$(readlink -f "\$0")")"
DESKTOP_FILE=\$(find "\${APPDIR}" -name "*.desktop" -print -quit 2>/dev/null)
APP_NAME="${APP_NAME}"
[ -n "\${DESKTOP_FILE}" ] && APP_NAME=\$(grep -i "^Name=" "\${DESKTOP_FILE}" | head -1 | cut -d'=' -f2)
SAVE_DIR="${SAVE_BASE_DIR}/\${APP_NAME}"
mkdir -p "\${SAVE_DIR}"
NWJS_PATH="${NWJS_PATH}"
[ ! -x "\${NWJS_PATH}" ] && NWJS_PATH=\$(command -v nw 2>/dev/null || command -v node-webkit 2>/dev/null || echo "nw")
cd "\${APPDIR}/game"
exec "\${NWJS_PATH}" . --no-sandbox
EOF
        ;;
    "wine")
        if [ -z "${WINE_EXEC}" ]; then
            WINE_EXEC=$(find "${GAME_SUBDIR}" -name "*.exe" -print -quit 2>/dev/null | xargs basename)
            if [ -z "${WINE_EXEC}" ]; then
                echo "âš ï¸  æœªæŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤: game.exe"
                WINE_EXEC="game.exe"
            fi
        fi
        
        cat > "${APP_DIR}/AppRun" << EOF
#!/bin/bash
APPDIR="\$(dirname "\$(readlink -f "\$0")")"
DESKTOP_FILE=\$(find "\${APPDIR}" -name "*.desktop" -print -quit 2>/dev/null)
APP_NAME="${APP_NAME}"
[ -n "\${DESKTOP_FILE}" ] && APP_NAME=\$(grep -i "^Name=" "\${DESKTOP_FILE}" | head -1 | cut -d'=' -f2)
SAVE_DIR="${SAVE_BASE_DIR}/\${APP_NAME}"
mkdir -p "\${SAVE_DIR}"
WINE_CMD="${WINE_CMD}"
WINE_EXEC="${WINE_EXEC}"
cd "\${APPDIR}/game"
[ ! -x "\$(command -v \${WINE_CMD})" ] && WINE_CMD="wine"
exec "\${WINE_CMD}" "\${WINE_EXEC}"
EOF
        ;;
    *)
        echo "âš ï¸  ä¸æ”¯æŒçš„ç±»åž‹: ${PACKAGE_TYPE}ï¼Œä½¿ç”¨é»˜è®¤: NW.js"
        PACKAGE_TYPE="nwjs"
        cat > "${APP_DIR}/AppRun" << EOF
#!/bin/bash
APPDIR="\$(dirname "\$(readlink -f "\$0")")"
APP_NAME="${APP_NAME}"
SAVE_DIR="${SAVE_BASE_DIR}/\${APP_NAME}"
mkdir -p "\${SAVE_DIR}"
NWJS_PATH="${NWJS_PATH}"
[ ! -x "\${NWJS_PATH}" ] && NWJS_PATH=\$(command -v nw 2>/dev/null || echo "nw")
cd "\${APPDIR}/game"
exec "\${NWJS_PATH}" . --no-sandbox
EOF
        ;;
esac

chmod +x "${APP_DIR}/AppRun"

# åˆ›å»º.desktop
cat > "${APP_DIR}/${APP_NAME}.desktop" << EOF
[Desktop Entry]
Name=${APP_NAME}
Exec=AppRun
Icon=${APP_NAME}
Terminal=false
Type=Application
Categories=Game;
X-AppImage-Version=${APP_VERSION}
X-AppImage-Type=${PACKAGE_TYPE}
EOF

# åˆ›å»ºå›¾æ ‡
if [ -n "${ICON_PATH}" ] && [ -f "${ICON_PATH}" ]; then
    echo "ðŸ–¼ï¸  ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡: ${ICON_PATH}"
    cp "${ICON_PATH}" "${APP_DIR}/${APP_NAME}.png"
else
    echo "ðŸŽ¨ ç”Ÿæˆé»˜è®¤å›¾æ ‡..."
    symbol=$(echo "${APP_NAME}" | head -c 2 | tr '[:lower:]' '[:upper:]' | sed 's/[^A-Z]//g')
    [ -z "${symbol}" ] && symbol=$(echo "${APP_NAME}" | head -c 1 | tr '[:lower:]' '[:upper:]')
    [ -z "${symbol}" ] && symbol="G"
    color_hex=$(printf "%06x" $((RANDOM % 0xFFFFFF)))
    if command -v convert &>/dev/null; then
        convert -size 256x256 xc:"#${color_hex}" \
            -fill white -font "DejaVu-Sans-Bold" -pointsize 48 \
            -gravity center -draw "text 0,0 '${symbol}'" \
            "${APP_DIR}/${APP_NAME}.png" 2>/dev/null || touch "${APP_DIR}/${APP_NAME}.png"
    else
        touch "${APP_DIR}/${APP_NAME}.png"
    fi
fi

# è¯¢é—®æ˜¯å¦æž„å»º
if [ "$AUTO_BUILD" = true ] || [ "$FORCE_BUILD" = true ]; then
    DO_BUILD="y"
else
    read -p "æž„å»ºAppImage? [Y/n]: " DO_BUILD
    DO_BUILD=${DO_BUILD:-Y}
fi

# æž„å»ºAppImage
if [[ "$DO_BUILD" =~ [Yy] ]]; then
    if command -v appimagetool &>/dev/null; then
        echo "ðŸš€ æž„å»ºAppImage: ${APPIMAGE_NAME}"
        export ARCH=x86_64
        appimagetool "${APP_DIR}" "${OUTPUT_DIR}/${APPIMAGE_NAME}"
        
        # ç§»åŠ¨åˆ°å½“å‰ä½ç½®
        if [ -f "${OUTPUT_DIR}/${APPIMAGE_NAME}" ]; then
            mv "${OUTPUT_DIR}/${APPIMAGE_NAME}" "./${APPIMAGE_NAME}"
            chmod +x "./${APPIMAGE_NAME}"
            echo "âœ… æž„å»ºå®Œæˆ: $(pwd)/${APPIMAGE_NAME}"
            echo "ðŸ” æŒ‚è½½åŽè·¯å¾„: /tmp/.mount_XXXX/game/ (å…¼å®¹éžASCIIå­—ç¬¦)"
            echo "ðŸ’¾ ç»Ÿä¸€å­˜æ¡£ä½ç½®: ${GAME_SAVE_DIR}"
        else
            echo "âŒ æž„å»ºå¤±è´¥ï¼Œæ–‡ä»¶æœªæ‰¾åˆ°"
            exit 1
        fi
        
        # æ¸…ç†æž„å»ºç›®å½•
        if [ "$FORCE_BUILD" = true ]; then
            CLEAN_BUILD="y"
        else
            read -p "æ¸…ç†æž„å»ºç›®å½•? [Y/n]: " CLEAN_BUILD
            CLEAN_BUILD=${CLEAN_BUILD:-Y}
        fi
        
        if [[ "$CLEAN_BUILD" =~ [Yy] ]]; then
            rm -rf "${OUTPUT_DIR}"
            echo "ðŸ§¹ æž„å»ºç›®å½•å·²æ¸…ç†"
        fi
    else
        echo "âŒ appimagetoolæœªå®‰è£…ï¼Œæ— æ³•æž„å»º"
        echo "ðŸ’¡ æ‰‹åŠ¨æž„å»ºå‘½ä»¤:"
        echo "   cd ${OUTPUT_DIR}"
        echo "   ARCH=x86_64 appimagetool ${APP_NAME}.AppDir ${APPIMAGE_NAME}"
    fi
else
    echo "â­ï¸  è·³è¿‡æž„å»º"
    echo "ðŸ’¡ æ‰‹åŠ¨æž„å»º:"
    echo "   cd ${OUTPUT_DIR}"
    echo "   chmod +x build.sh"
    echo "   ./build.sh"
    
    # åˆ›å»ºæž„å»ºè„šæœ¬
    mkdir -p "${OUTPUT_DIR}"
    cat > "${OUTPUT_DIR}/build.sh" << EOF
#!/bin/bash
set -e
export ARCH=x86_64
appimagetool "${APP_NAME}.AppDir" "${APPIMAGE_NAME}"
EOF
    chmod +x "${OUTPUT_DIR}/build.sh"
fi